<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Scanner Resi Pengiriman</title>
  <script src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; }
    #preview { width: 300px; border: 2px solid #333; margin: 10px auto; }
    table { border-collapse: collapse; width: 100%; margin-top: 15px; }
    th, td { border: 1px solid #999; padding: 6px; }
    button { margin: 8px; padding: 8px 16px; cursor: pointer; }
  </style>
</head>
<body>
  <h2>üì¶ Scanner Resi Pengiriman</h2>

  <!-- Input nama penerima -->
  <label>Nama Penerima:</label>
  <input type="text" id="namaInput" placeholder="Isi nama penerima"><br><br>

  <!-- Kamera preview -->
  <video id="preview"></video>

  <!-- Tombol -->
  <div>
    <button onclick="resetScanner()">üîÑ Scan Ulang</button>
    <button onclick="saveToSheet()">üíæ Simpan ke Spreadsheet</button>
  </div>

  <h3>Hasil Scan:</h3>
  <table id="resultTable">
    <tr>
      <th>Tanggal</th>
      <th>Jam</th>
      <th>Nomor Resi</th>
      <th>Nama</th>
      <th>Ekspedisi</th>
    </tr>
  </table>

  <script>
    const GOOGLE_SHEET_URL = "https://script.google.com/macros/s/AKfycbzkYfq4uK1x93SPTIrhak5dynDQsGZWZaRvB9wfg4ncCbwYHvYogkmVjoygAvlBIgHh/exec";
    const GOOGLE_SHEET_TOKEN = "DSC-YOGYA";

    let scanner;
    let hasilScan = [];

    // Mapping ekspedisi
    function getEkspedisi(resi) {
      if (resi.startsWith("JX")) return "J&T";
      if (resi.startsWith("TTSPO")) return "Posind";
      if (resi.startsWith("TSPX")) return "PAXEL";
      if (resi.startsWith("TG")) return "JNE REG";
      if (resi.startsWith("TSA")) return "Antaraja";
      return "Lainnya";
    }

    // Update tabel
    function updateTabel() {
      let table = document.getElementById("resultTable");
      table.innerHTML = `
        <tr>
          <th>Tanggal</th>
          <th>Jam</th>
          <th>Nomor Resi</th>
          <th>Nama</th>
          <th>Ekspedisi</th>
        </tr>`;
      hasilScan.forEach(data => {
        let row = table.insertRow();
        row.insertCell(0).innerText = data.tanggal;
        row.insertCell(1).innerText = data.jam;
        row.insertCell(2).innerText = data.resi;
        row.insertCell(3).innerText = data.nama;
        row.insertCell(4).innerText = data.ekspedisi;
      });
    }

    // Kirim ke Google Sheet
    async function saveToSheet() {
      if (hasilScan.length === 0) {
        alert("Belum ada data untuk disimpan!");
        return;
      }
      try {
        await fetch(GOOGLE_SHEET_URL, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            token: GOOGLE_SHEET_TOKEN,
            data: hasilScan
          })
        });
        alert("‚úÖ Data berhasil dikirim ke Spreadsheet!");
        hasilScan = [];
        updateTabel();
      } catch (e) {
        console.error(e);
        alert("‚ùå Gagal kirim ke Spreadsheet!");
      }
    }

    // Reset scanner
    function resetScanner() {
      if (scanner) {
        scanner.stop();
      }
      startScanner();
    }

    // Mulai scanner
    function startScanner() {
      scanner = new Instascan.Scanner({ video: document.getElementById('preview') });
      scanner.addListener('scan', function (content) {
        const now = new Date();
        const tanggal = now.toLocaleDateString("id-ID");
        const jam = now.toLocaleTimeString("id-ID");
        const nama = document.getElementById("namaInput").value || "-";

        let data = {
          tanggal: tanggal,
          jam: jam,
          resi: content,
          nama: nama,
          ekspedisi: getEkspedisi(content)
        };

        hasilScan.push(data);
        updateTabel();
      });

      Instascan.Camera.getCameras().then(function (cameras) {
        if (cameras.length > 0) {
          // Default pakai kamera belakang (cameras[0])
          scanner.start(cameras[0]);
        } else {
          alert("‚ùå Tidak ada kamera terdeteksi!");
        }
      }).catch(function (e) {
        console.error(e);
        alert("Error kamera: " + e);
      });
    }

    // Jalankan saat load
    startScanner();
  </script>
</body>
</html>
