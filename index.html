<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Scanner Resi</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>
  <h2>ðŸ“¦ Scanner Resi Pengiriman</h2>

  <!-- Input nama penerima -->
  <label>Nama Penerima:</label>
  <input type="text" id="namaInput" placeholder="Isi nama penerima"><br><br>

  <!-- Kamera untuk scan -->
  <div id="reader" style="width:300px;"></div>

  <h3>Hasil Scan:</h3>
  <table border="1" id="resultTable">
    <tr>
      <th>Tanggal</th>
      <th>Jam</th>
      <th>Nomor Resi</th>
      <th>Nama</th>
      <th>Ekspedisi</th>
    </tr>
  </table>

  <script>
    const GOOGLE_SHEET_URL = "URL_WEB_APP_DARI_STEP3";
    const GOOGLE_SHEET_TOKEN = "DSC-YOGYA";

    function getEkspedisi(resi) {
      if (resi.startsWith("JX")) return "J&T";
      if (resi.startsWith("TTSPO")) return "Posind";
      if (resi.startsWith("TSPX")) return "PAXEL";
      if (resi.startsWith("TG")) return "JNE REG";
      if (resi.startsWith("TSA")) return "Antaraja";
      return "Lainnya";
    }

    async function sendToSheet(data) {
      try {
        let res = await fetch(GOOGLE_SHEET_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token: GOOGLE_SHEET_TOKEN, ...data })
        });
        console.log("Respon server:", await res.text());
      } catch (e) {
        console.error("Gagal kirim ke sheet:", e);
      }
    }

    function addRow(data) {
      let table = document.getElementById("resultTable");
      let row = table.insertRow();
      row.insertCell(0).innerText = data.tanggal;
      row.insertCell(1).innerText = data.jam;
      row.insertCell(2).innerText = data.resi;
      row.insertCell(3).innerText = data.nama;
      row.insertCell(4).innerText = data.ekspedisi;
    }

    let lastScanned = "";

    function onScanSuccess(decodedText) {
      if (decodedText === lastScanned) return;
      lastScanned = decodedText;

      let nama = document.getElementById("namaInput").value || "-";
      let now = new Date();
      let tanggal = now.toLocaleDateString("id-ID");
      let jam = now.toLocaleTimeString("id-ID");

      let data = {
        tanggal,
        jam,
        resi: decodedText,
        nama,
        ekspedisi: getEkspedisi(decodedText)
      };

      addRow(data);
      sendToSheet(data);

      setTimeout(() => { lastScanned = ""; }, 3000);
    }

    let html5QrcodeScanner = new Html5QrcodeScanner(
      "reader", { fps: 10, qrbox: 250 }
    );
    html5QrcodeScanner.render(onScanSuccess);
  </script>
</body>
</html>
