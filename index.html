<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Scanner Resi</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>
  <h2>ðŸ“¦ Scanner Resi Pengiriman</h2>

  <!-- Input nama penerima -->
  <label>Nama Penerima:</label>
  <input type="text" id="namaInput" placeholder="Isi nama penerima"><br><br>

  <!-- Kamera untuk scan -->
  <div id="reader" style="width:300px;"></div>

  <h3>Hasil Scan:</h3>
  <table border="1" id="resultTable">
    <tr>
      <th>Tanggal</th>
      <th>Jam</th>
      <th>Nomor Resi</th>
      <th>Nama</th>
      <th>Ekspedisi</th>
    </tr>
  </table>

  <button id="saveBtn" onclick="saveToSheet()" disabled>ðŸ’¾ Simpan ke Spreadsheet</button>
  <button id="scanAgainBtn" onclick="startScanner()" style="display:none;">ðŸ”„ Scan Lagi</button>

  <script>
    const GOOGLE_SHEET_URL = "https://script.google.com/macros/s/AKfycbyTxuWYsOqygAJhg85FkKU4RqZ2V72naKaAYVCl4cMe_FHLgyp6USGBW5xI_N06SXuB_g/exec";
    const GOOGLE_SHEET_TOKEN = "DSC-YOGYA";

    let lastScanned = "";
    let scannedData = null;
    let scanner;

    // mapping kode ekspedisi
    function getEkspedisi(resi) {
      if (resi.startsWith("JX")) return "J&T";
      if (resi.startsWith("TTSPO")) return "Posind";
      if (resi.startsWith("TSPX")) return "PAXEL";
      if (resi.startsWith("TG")) return "JNE REG";
      if (resi.startsWith("TSA")) return "Antaraja";
      return "Lainnya";
    }

    function addRow(data) {
      let table = document.getElementById("resultTable");
      let row = table.insertRow();
      row.insertCell(0).innerText = data.tanggal;
      row.insertCell(1).innerText = data.jam;
      row.insertCell(2).innerText = data.resi;
      row.insertCell(3).innerText = data.nama;
      row.insertCell(4).innerText = data.ekspedisi;
    }

    // kirim ke spreadsheet
    async function saveToSheet() {
      if (!scannedData) return;
      try {
        await fetch(GOOGLE_SHEET_URL, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token: GOOGLE_SHEET_TOKEN, ...scannedData })
        });
        alert("âœ… Data berhasil disimpan!");
        document.getElementById("saveBtn").disabled = true;
        document.getElementById("scanAgainBtn").style.display = "inline-block";
      } catch (e) {
        alert("âŒ Gagal simpan: " + e);
      }
    }

    function onScanSuccess(decodedText) {
      if (decodedText === lastScanned) return; // cegah duplikat
      lastScanned = decodedText;

      let nama = document.getElementById("namaInput").value || "-";
      let now = new Date();
      let tanggal = now.toLocaleDateString("id-ID");
      let jam = now.toLocaleTimeString("id-ID");

      scannedData = {
        tanggal,
        jam,
        resi: decodedText,
        nama,
        ekspedisi: getEkspedisi(decodedText)
      };

      addRow(scannedData);

      // stop scanner setelah berhasil
      scanner.clear().then(() => {
        document.getElementById("saveBtn").disabled = false;
      });
    }

    function startScanner() {
      lastScanned = "";
      scannedData = null;
      document.getElementById("saveBtn").disabled = true;
      document.getElementById("scanAgainBtn").style.display = "none";

      scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
      scanner.render(onScanSuccess);
    }

    // mulai pertama kali
    startScanner();
  </script>
</body>
</html>
