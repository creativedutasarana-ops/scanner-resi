<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Scanner Resi</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body {
            background: #111;
            color: #eee;
            font-family: 'Segoe UI', Arial, sans-serif;
            padding: 20px;
        }
        h2 {
            color: #4CAF50;
        }
        #reader {
            width: 100%;
            max-width: 400px;
            margin: 20px 0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }
        .mode-container {
            margin: 15px 0;
        }
        .mode-container button {
            padding: 8px 15px;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        #modeTunggal {
            background-color: #2e8b57;
            color: white;
        }
        #modeMassal {
            background-color: #556b2f;
            color: white;
        }
        #modeTunggal.active, #modeMassal.active {
            background-color: #4CAF50;
        }
        input[type="text"] {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #555;
            background: #333;
            color: #eee;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #444;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #333;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-right: 10px;
        }
        #saveBtn {
            background-color: #4CAF50;
            color: white;
        }
        #saveBtn:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        #scanAgainBtn {
            background-color: #f44336;
            color: white;
        }
        .message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
            display: none;
        }
        .message.success {
            background-color: #388E3C;
            color: white;
        }
        .message.error {
            background-color: #D32F2F;
            color: white;
        }
        .message.info {
            background-color: #1a73e8;
            color: white;
        }
    </style>
</head>
<body>
    <h2>ðŸ“¦ Scanner Resi Pengiriman</h2>

    <div class="mode-container">
        <label>Pilih Mode:</label><br>
        <button id="modeTunggal" class="active">Satu per Satu</button>
        <button id="modeMassal">Massal</button>
    </div>

    <label>Nama Penerima:</label>
    <input type="text" id="namaInput" placeholder="Isi nama penerima"><br><br>

    <div id="reader"></div>

    <h3>Hasil Scan:</h3>
    <table border="1" id="resultTable">
        <thead>
            <tr>
                <th>Tanggal</th>
                <th>Jam</th>
                <th>Ekspedisi</th>
                <th>Nomor Resi</th>
                <th>Nama</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>

    <div id="buttons" style="margin-top:10px;">
        <button id="saveBtn" disabled>Simpan ke Spreadsheet</button>
        <button id="scanAgainBtn" disabled>Reset Scan</button>
    </div>

    <div id="messageBox" class="message"></div>

    <script>
        const GOOGLE_SHEET_URL = "https://script.google.com/macros/s/AKfycbzBKs6Io3yUi-NVc1H1y3kor1wYcUzih7PFGjdBx2RIrPsdebORfV2HNlF_GoWzTHSF/exec"; // Ganti dengan URL skrip Anda
        
        const getEkspedisi = (resi) => {
            if (resi.startsWith("JX")) return "J&T";
            if (resi.startsWith("TTSPO")) return "Posind";
            if (resi.startsWith("TSPX")) return "PAXEL";
            if (resi.startsWith("TSA")) return "Antaraja";
            if (resi.startsWith("TG0")) return "JNE JTR";
            if (resi.startsWith("TG7")) return "JNE REG";
            return "Lainnya";
        };

        let scanner;
        let isMassalMode = false;
        let scannedData = [];
        let isScanning = false;

        const readerDiv = document.getElementById("reader");
        const namaInput = document.getElementById("namaInput");
        const resultTableBody = document.querySelector("#resultTable tbody");
        const saveBtn = document.getElementById("saveBtn");
        const scanAgainBtn = document.getElementById("scanAgainBtn");
        const modeTunggalBtn = document.getElementById("modeTunggal");
        const modeMassalBtn = document.getElementById("modeMassal");
        const messageBox = document.getElementById("messageBox");

        const showMessage = (text, type) => {
            messageBox.innerText = text;
            messageBox.className = `message ${type}`;
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 3000);
        };

        const onScanSuccess = (decodedText) => {
            // Periksa apakah resi sudah ada di array
            if (scannedData.some(item => item.resi === decodedText)) {
                showMessage("âŒ Resi ini sudah discan!", "error");
                return; // Berhenti tanpa menambahkan data duplikat
            }

            showMessage("âœ… Resi berhasil di-scan!", "success");

            const nama = namaInput.value || "-";
            const now = new Date();
            const newData = {
                tanggal: now.toLocaleDateString("id-ID"),
                jam: now.toLocaleTimeString("id-ID"),
                resi: decodedText,
                nama: nama,
                ekspedisi: getEkspedisi(decodedText)
            };
            
            scannedData.push(newData);
            
            const row = resultTableBody.insertRow();
            row.insertCell(0).innerText = newData.tanggal;
            row.insertCell(1).innerText = newData.jam;
            row.insertCell(2).innerText = newData.ekspedisi;
            row.insertCell(3).innerText = newData.resi;
            row.insertCell(4).innerText = newData.nama;

            saveBtn.disabled = false;
            scanAgainBtn.disabled = false;
            
            if (!isMassalMode) {
                // Hentikan pemindai hanya untuk mode tunggal
                scanner.stop().then(() => {
                    isScanning = false;
                    sendData(scannedData);
                }).catch(err => {
                    console.error("Gagal menghentikan pemindai:", err);
                    sendData(scannedData);
                });
            }
        };

        const startScanner = () => {
            if (isScanning) return;
            scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
            scanner.render(onScanSuccess);
            isScanning = true;
        };

        const sendData = async (dataToSend) => {
            try {
                const url = new URL(GOOGLE_SHEET_URL);
                url.searchParams.append('data', JSON.stringify(dataToSend));
                
                const formattedData = dataToSend.map(d => ({
                    tanggal: d.tanggal,
                    jam: d.jam,
                    ekspedisi: d.ekspedisi,
                    resi: d.resi,
                    nama: d.nama
                }));

                await fetch(url, {
                    method: "POST",
                    mode: "no-cors",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(formattedData)
                });
                
                showMessage("âœ… Data scan telah berhasil disimpan!", "success");
                
                scannedData = [];
                resultTableBody.innerHTML = '';
                saveBtn.disabled = true;
                scanAgainBtn.disabled = true;
                namaInput.value = '';
                
            } catch (e) {
                showMessage(`âŒ Gagal menyimpan data: ${e.message}`, "error");
            }
        };

        // Mulai pemindai saat halaman selesai dimuat
        window.addEventListener('load', () => {
            startScanner();
        });

        modeTunggalBtn.addEventListener("click", () => {
            isMassalMode = false;
            modeTunggalBtn.classList.add('active');
            modeMassalBtn.classList.remove('active');
            showMessage("Mode: Satu per Satu", "info");
            
            if (scannedData.length > 0) {
                scannedData = [];
                resultTableBody.innerHTML = '';
                saveBtn.disabled = true;
                scanAgainBtn.disabled = true;
            }
            if (!isScanning) startScanner();
        });

        modeMassalBtn.addEventListener("click", () => {
            isMassalMode = true;
            modeMassalBtn.classList.add('active');
            modeTunggalBtn.classList.remove('active');
            showMessage("Mode: Massal", "info");
            if (!isScanning) startScanner();
        });

        saveBtn.addEventListener("click", () => {
            if (scannedData.length === 0) {
                showMessage("Tidak ada data untuk disimpan.", "error");
                return;
            }
            sendData(scannedData);
        });

        scanAgainBtn.addEventListener("click", () => {
            scannedData = [];
            resultTableBody.innerHTML = '';
            saveBtn.disabled = true;
            scanAgainBtn.disabled = true;
            namaInput.value = '';
            if (!isScanning) startScanner();
        });
    </script>
</body>
</html>
