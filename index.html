<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Scanner Resi Pengiriman</title>
  <style>
    body { font-family: Arial, sans-serif; background: #111; color: #fff; text-align: center; }
    h1 { margin: 20px 0; }
    table { border-collapse: collapse; margin: 20px auto; }
    th, td { border: 1px solid #555; padding: 6px 12px; }
    th { background: #333; }
    button { margin: 10px; padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; }
    #saveBtn { background: green; color: white; }
    #scanAgainBtn { background: orange; color: white; }
  </style>
</head>
<body>
  <h1>ðŸ“¦ Scanner Resi Pengiriman</h1>

  <label>Nama Penerima:
    <input type="text" id="namaInput" placeholder="Nama penerima">
  </label>

  <div style="margin:20px;">
    <video id="preview" width="300" height="200" style="border:1px solid #555;"></video>
  </div>

  <h3>Hasil Scan:</h3>
  <table id="hasilTable">
    <thead>
      <tr>
        <th>Tanggal</th>
        <th>Jam</th>
        <th>Nomor Resi</th>
        <th>Nama</th>
        <th>Ekspedisi</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button id="saveBtn">Simpan ke Spreadsheet</button>
  <button id="scanAgainBtn">Scan Lagi</button>

  <script src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
  <script>
    let scanner;
    let hasilScan = [];

    // Inisialisasi kamera
function startScanner() {
  scanner = new Instascan.Scanner({ video: document.getElementById('preview') });
  scanner.addListener('scan', function (content) {
    const now = new Date();
    const tanggal = now.toLocaleDateString();
    const jam = now.toLocaleTimeString();
    const nama = document.getElementById("namaInput").value || "-";

    // Misalnya format hasil scan "RESI12345|JNE"
    let [resi, ekspedisi] = content.split("|");
    if (!ekspedisi) ekspedisi = "-";

    hasilScan.push({
      tanggal: tanggal,
      jam: jam,
      resi: resi,
      nama: nama,
      ekspedisi: ekspedisi
    });

    updateTabel();
  });

  Instascan.Camera.getCameras().then(function (cameras) {
    if (cameras.length > 0) {
      // Cari kamera belakang
      let backCam = cameras.find(cam => cam.name.toLowerCase().includes('back'));
      if (backCam) {
        scanner.start(backCam);
      } else {
        scanner.start(cameras[0]); // fallback
      }
    } else {
      alert('Tidak ada kamera terdeteksi');
    }
  }).catch(function (e) {
    console.error(e);
    alert("Error kamera: " + e);
  });
}

    // Update tabel hasil scan
    function updateTabel() {
      let tbody = document.querySelector("#hasilTable tbody");
      tbody.innerHTML = "";
      hasilScan.forEach(row => {
        let tr = `<tr>
          <td>${row.tanggal}</td>
          <td>${row.jam}</td>
          <td>${row.resi}</td>
          <td>${row.nama}</td>
          <td>${row.ekspedisi}</td>
        </tr>`;
        tbody.innerHTML += tr;
      });
    }

    // Tombol Simpan
    document.getElementById("saveBtn").addEventListener("click", function () {
      if (hasilScan.length === 0) {
        alert("Belum ada data untuk disimpan.");
        return;
      }

      fetch("https://script.google.com/macros/s/AKfycbzkYfq4uK1x93SPTIrhak5dynDQsGZWZaRvB9wfg4ncCbwYHvYogkmVjoygAvlBIgHh/exec", {
        method: "POST",
        body: JSON.stringify(hasilScan),
        headers: {
          "Content-Type": "application/json",
        },
      })
      .then(res => res.json())
      .then(response => {
        alert("âœ… Data berhasil disimpan ke Spreadsheet!");
        hasilScan = []; // kosongkan array setelah simpan
        updateTabel();
      })
      .catch(err => {
        console.error("Error:", err);
        alert("Gagal menyimpan ke Spreadsheet.");
      });
    });

    // Tombol Scan Lagi
    document.getElementById("scanAgainBtn").addEventListener("click", function () {
      if (scanner) {
        scanner.stop().then(() => {
          startScanner();
        });
      } else {
        startScanner();
      }
    });

    // Mulai scanner pertama kali
    startScanner();
  </script>
</body>
</html>
