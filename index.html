<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Scanner Resi</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body style="background:#111; color:white; font-family:Arial; padding:20px;">
  <h2>📦 Scanner Resi Pengiriman</h2>

  <!-- Input nama penerima -->
  <label>Nama Penerima:</label>
  <input type="text" id="namaInput" placeholder="Isi nama penerima"><br><br>

  <!-- Kamera untuk scan -->
  <div id="reader" style="width:300px;"></div>

  <h3>Hasil Scan:</h3>
  <table border="1" id="resultTable">
    <tr>
      <th>Tanggal</th>
      <th>Jam</th>
      <th>Nomor Resi</th>
      <th>Nama</th>
      <th>Ekspedisi</th>
    </tr>
  </table>

  <div id="buttons" style="margin-top:10px;">
    <button id="saveBtn" disabled>Simpan ke Spreadsheet</button>
    <button id="scanAgainBtn" disabled>Scan Lagi</button>
  </div>

  <script>
    const GOOGLE_SHEET_URL = "https://script.google.com/macros/s/AKfycbwGlz9ygn9bu2G36ltnL3oGU45gK6KdNtfP3eigPJsaM6I9fXo-mFt9xFGiNAg0cQpf/exec";

    function getEkspedisi(resi) {
      if (resi.startsWith("JX")) return "J&T";
      if (resi.startsWith("TTSPO")) return "Posind";
      if (resi.startsWith("TSPX")) return "PAXEL";
      if (resi.startsWith("TG")) return "JNE REG";
      if (resi.startsWith("TSA")) return "Antaraja";
      return "Lainnya";
    }

    let currentData = null;
    let scanner;

    function startScanner() {
      scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
      scanner.render(onScanSuccess);
    }

    function onScanSuccess(decodedText) {
      if (currentData) return; // biar ga terus-terusan scan

      let nama = document.getElementById("namaInput").value || "-";
      let now = new Date();
      let tanggal = now.toLocaleDateString("id-ID");
      let jam = now.toLocaleTimeString("id-ID");

      currentData = {
        tanggal,
        jam,
        resi: decodedText,
        nama,
        ekspedisi: getEkspedisi(decodedText)
      };

      let table = document.getElementById("resultTable");
      let row = table.insertRow();
      row.insertCell(0).innerText = currentData.tanggal;
      row.insertCell(1).innerText = currentData.jam;
      row.insertCell(2).innerText = currentData.resi;
      row.insertCell(3).innerText = currentData.nama;
      row.insertCell(4).innerText = currentData.ekspedisi;

      document.getElementById("saveBtn").disabled = false;
      document.getElementById("scanAgainBtn").disabled = false;
    }

    startScanner();

    document.getElementById("saveBtn").addEventListener("click", async () => {
      if (!currentData) return;
      try {
        await fetch(GOOGLE_SHEET_URL, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(currentData)
        });
        alert("✅ Data berhasil disimpan ke Spreadsheet!");
        document.getElementById("saveBtn").disabled = true;
      } catch (e) {
        alert("❌ Gagal menyimpan data: " + e);
      }
    });

    document.getElementById("scanAgainBtn").addEventListener("click", () => {
      currentData = null;
      document.getElementById("saveBtn").disabled = true;
      document.getElementById("scanAgainBtn").disabled = true;
    });
  </script>
</body>
</html>
